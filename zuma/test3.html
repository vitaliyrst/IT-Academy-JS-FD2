<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<script>

    /* let bezier = [
         {A: {x: 655, y: 0}, B: {x: 658, y: 110}, C: {x: 660, y: 220}, D: {x: 650, y: 330}},
         {A: {x: 650, y: 330}, B: {x: 630, y: 420}, C: {x: 585, y: 480}, D: {x: 505, y: 527}},
         {A: {x: 505, y: 527}, B: {x: 412, y: 570}, C: {x: 312, y: 560}, D: {x: 235, y: 505}},
         {A: {x: 235, y: 505}, B: {x: 180, y: 464}, C: {x: 140, y: 400}, D: {x: 136, y: 301}},
         {A: {x: 136, y: 301}, B: {x: 140, y: 200}, C: {x: 179, y: 145}, D: {x: 250, y: 97}},
         {A: {x: 250, y: 97}, B: {x: 322, y: 55}, C: {x: 418, y: 60}, D: {x: 489, y: 100}},
         {A: {x: 489, y: 100}, B: {x: 590, y: 170}, C: {x: 590, y: 250}, D: {x: 590, y: 300}},
         {A: {x: 590, y: 300}, B: {x: 575, y: 420}, C: {x: 500, y: 475}, D: {x: 433, y: 491}},
         {A: {x: 433, y: 491}, B: {x: 300, y: 520}, C: {x: 221, y: 415}, D: {x: 207, y: 356}},
         {A: {x: 207, y: 356}, B: {x: 180, y: 255}, C: {x: 222, y: 175}, D: {x: 320, y: 137}},
         {A: {x: 320, y: 137}, B: {x: 450, y: 100}, C: {x: 550, y: 215}, D: {x: 526, y: 324}},
         {A: {x: 526, y: 324}, B: {x: 500, y: 405}, C: {x: 417, y: 445}, D: {x: 345, y: 423}},
         {A: {x: 345, y: 423}, B: {x: 265, y: 385}, C: {x: 260, y: 325}, D: {x: 266, y: 253}},
     ];*/

    let bezier = [
        {A: {x: 250, y: -30}, B: {x: 40, y: 152}, C: {x: 20, y: 318}, D: {x: 92, y: 515}},
        {A: {x: 92, y: 515}, B: {x: 145, y: 630}, C: {x: 250, y: 750}, D: {x: 416, y: 755}},
        {A: {x: 416, y: 755}, B: {x: 539, y: 760}, C: {x: 721, y: 780}, D: {x: 893, y: 691}},
        {A: {x: 893, y: 691}, B: {x: 970, y: 652}, C: {x: 1030, y: 551}, D: {x: 1035, y: 469}},
        {A: {x: 1035, y: 469}, B: {x: 1050, y: 370}, C: {x: 1023, y: 247}, D: {x: 1013, y: 193}},
        {A: {x: 1013, y: 193}, B: {x: 970, y: 60}, C: {x: 920, y: 50}, D: {x: 870, y: 120}},
        {A: {x: 870, y: 120}, B: {x: 845, y: 160}, C: {x: 905, y: 252}, D: {x: 913, y: 344}},
        {A: {x: 913, y: 344}, B: {x: 930, y: 431}, C: {x: 880, y: 550}, D: {x: 813, y: 593}},
        {A: {x: 813, y: 593}, B: {x: 730, y: 660}, C: {x: 640, y: 640}, D: {x: 682, y: 540}},
        {A: {x: 682, y: 540}, B: {x: 750, y: 506}, C: {x: 800, y: 436}, D: {x: 797, y: 362}},
        {A: {x: 797, y: 362}, B: {x: 800, y: 200}, C: {x: 701, y: 150}, D: {x: 601, y: 136}},
        {A: {x: 601, y: 136}, B: {x: 468, y: 120}, C: {x: 363, y: 170}, D: {x: 327, y: 261}},
        {A: {x: 327, y: 261}, B: {x: 300, y: 336}, C: {x: 290, y: 413}, D: {x: 370, y: 491}},
        {A: {x: 370, y: 491}, B: {x: 460, y: 549}, C: {x: 418, y: 630}, D: {x: 392, y: 628}},
        {A: {x: 392, y: 628}, B: {x: 318, y: 650}, C: {x: 230, y: 552}, D: {x: 206, y: 494}},
        {A: {x: 206, y: 494}, B: {x: 140, y: 366}, C: {x: 160, y: 241}, D: {x: 253, y: 146}},
    ];

    let bez = [];
    for (let i = 0; i < bezier.length; i++) {
        let aX = bezier[i].A.x / 1.2;
        let bX = bezier[i].B.x / 1.2;
        let cX = bezier[i].C.x / 1.2;
        let dX = bezier[i].D.x / 1.2;
        let aY = bezier[i].A.y / 1.2;
        let bY = bezier[i].B.y / 1.2;
        let cY = bezier[i].C.y / 1.2;
        let dY = bezier[i].D.y / 1.2;
        bez.push({A: {x: aX, y: aY}, B: {x: bX, y: bY}, C: {x: cX, y: cY}, D: {x: dX, y: dY}});
    }

    console.log(bez);
    bezier = bez;

    const Y = bezier.map((seg, i) => {
        return (function (t) {
            return ({
                x: (
                    (Math.pow(1 - t, 3) * seg.A.x) +
                    (3 * Math.pow(1 - t, 2) * t * seg.B.x) +
                    (3 * (1 - t) * Math.pow(t, 2) * seg.C.x) +
                    (Math.pow(t, 3) * seg.D.x)
                ),
                y: (
                    (Math.pow(1 - t, 3) * seg.A.y) +
                    (3 * Math.pow(1 - t, 2) * t * seg.B.y) +
                    (3 * (1 - t) * Math.pow(t, 2) * seg.C.y) +
                    (Math.pow(t, 3) * seg.D.y)
                ),
            });
        });
    });

    const s = [];
    const n = 960;
    const m = Array(bezier.length).fill(n / bezier.length);

    bezier.forEach((seg, i) => {
        s[i] = [];
        const dt = 1 / m[i];

        for (let t = 0; t < 1; t += dt) {

            s[i].push(Y[i](t));
        }
    });

    function mag(a, b) {
        return Math.sqrt(Math.pow(a, 2) + Math.pow(b, 2));
    }

    let l = [];
    for (let i = 0; i < bezier.length; i++) {
        l[i] = 0;
        for (let j = 0; j < m[i] - 1; j++) {
            l[i] += mag(
                (s[i][j + 1].x - s[i][j].x),
                (s[i][j + 1].y - s[i][j].y)
            );
        }
        if (i < bezier.length - 1) {
            l[i] += mag(
                (s[i + 1][0].x - s[i][m[i] - 1].x),
                (s[i + 1][0].y - s[i][m[i] - 1].y)
            );
        }
    }
    const l_total = l.reduce((a, c) => {
        return a + c;
    });


    bezier.forEach((seg, i) => {
        s[i] = [];
        m[i] = Math.floor((l[i] / l_total) * n);
        const dt = 1 / m[i];
        for (let t = 0; t < 1; t += dt) {
            s[i].push(Y[i](t));
        }
    });

    const d_avg = l_total / (n - 1);
    const step_size = (1 / n) / 10;

    for (let i = 0; i < bezier.length; i++) {
        let t = [];
        for (let j = 0; j < m[i]; j++) {
            t[j] = j / m[i];
        }
        for (let r = 0; r < 100; r++) {
            let d = [];
            for (let j = 0; j < m[i] - 1; j++) {
                d[j] = mag(
                    (s[i][j + 1].x - s[i][j].x),
                    (s[i][j + 1].y - s[i][j].y)
                );
            }
            const d_err = d.map((segment) => {
                return (segment - d_avg);
            });
            let offset = 0;
            const cutoff = (i === bezier.length - 1) ? 0 : 1;
            for (let j = 1; j < m[i] - cutoff; j++) {
                offset += d_err[j - 1];
                t[j] -= step_size * offset;
                s[i][j] = Y[i](t[j]);
            }
        }
    }

    let b = [];

    for (let i = 0; i < s.length; i++) {
        for (let j = 0; j < s[i].length; j++) {
            b.push(s[i][j]);
        }
    }

    let json = JSON.stringify(b);
    console.log(json)
</script>
</body>
</html>